<%
  // ------------------------------------------------------------
  // SAFE INPUTS (nie direkt auf evtl. nicht definierte Variablen)
  // ------------------------------------------------------------
  const L = (typeof locals !== "undefined" && locals) ? locals : {};

  const userSafe =
    L.user ||
    (typeof user !== "undefined" ? user : null);

  const titleSafe =
    L.title ||
    (typeof title !== "undefined" ? title : null);

  const tenantIdSafe =
    (typeof L.tenantId !== "undefined" ? L.tenantId :
    (typeof tenantId !== "undefined" ? tenantId : ""));

  const enabledAppsSafe =
    (typeof L.enabledApps !== "undefined" ? L.enabledApps :
    (typeof enabledApps !== "undefined" ? enabledApps : []));

  const activeSectionSafe =
    (typeof L.activeSection !== "undefined" ? L.activeSection :
    (typeof activeSection !== "undefined" ? activeSection : ""));

  const currentAppSafe =
    (typeof L.currentApp !== "undefined" ? L.currentApp :
    (typeof currentApp !== "undefined" ? currentApp : ""));

  // ------------------------------------------------------------
  // Roles / Flags
  // ------------------------------------------------------------
  function hasRole(name) {
    const roles = (userSafe && userSafe.roles) ? userSafe.roles : [];
    if (!Array.isArray(roles)) return false;
    return roles.some(r => {
      if (typeof r === "string") return r === name;
      if (r && typeof r === "object") return r.role === name || r.name === name;
      return false;
    });
  }

  const isSuperadmin = hasRole("superadmin");
  const isTenantAdmin = hasRole("admin") || hasRole("tenant_admin") || isSuperadmin;

  // ------------------------------------------------------------
  // Tenant / Apps
  // ------------------------------------------------------------
  const t = tenantIdSafe || (userSafe && userSafe.tenantId) || "";
  const tenantBase = t ? ("/tenant/" + encodeURIComponent(String(t))) : "";
  const apps = Array.isArray(enabledAppsSafe) ? enabledAppsSafe : [];

  const active = (typeof activeSectionSafe === "string") ? activeSectionSafe : "";
  const activeApp = currentAppSafe ? String(currentAppSafe) : "";
%>

<div class="flex items-start justify-between gap-6">
  <div>
    <h1 class="text-2xl font-bold"><%= titleSafe || "MDX Platform" %></h1>
    <p class="text-sm text-gray-500">
      <% if (userSafe) { %>
        Eingeloggt als <span class="font-mono"><%= userSafe.email %></span>
      <% } else { %>
        <span class="text-red-600">Kein User in Template-Daten</span>
      <% } %>
      <% if (t) { %> · Tenant: <span class="font-mono"><%= t %></span><% } %>
    </p>
  </div>

  <div class="flex items-center gap-3">
    <a href="/logout" class="text-sm text-red-600 hover:underline">Logout</a>
  </div>
</div>

<div class="mt-4 grid grid-cols-1 md:grid-cols-3 gap-3">
  <!-- PLATFORM -->
  <div class="bg-white rounded-xl shadow px-4 py-3">
    <div class="flex items-center justify-between mb-2">
      <div class="text-[11px] uppercase tracking-wide text-gray-400">Platform</div>
      <% if (active === "platform") { %>
        <span class="text-[10px] px-2 py-0.5 rounded-full bg-blue-50 text-blue-700 border border-blue-100">aktiv</span>
      <% } %>
    </div>

    <div class="flex flex-wrap gap-3 text-sm">
      <% if (isSuperadmin) { %>
        <a href="/tenants" class="<%= active === 'platform' ? 'text-blue-700 font-medium' : 'text-gray-700' %> hover:underline">
          Tenants
        </a>
      <% } else { %>
        <span class="text-gray-400">Tenants (superadmin)</span>
      <% } %>
    </div>
  </div>

  <!-- TENANT ADMIN -->
  <div class="bg-white rounded-xl shadow px-4 py-3">
    <div class="flex items-center justify-between mb-2">
      <div class="text-[11px] uppercase tracking-wide text-gray-400">Tenant Admin</div>
      <% if (active === "tenant") { %>
        <span class="text-[10px] px-2 py-0.5 rounded-full bg-blue-50 text-blue-700 border border-blue-100">aktiv</span>
      <% } %>
    </div>

    <div class="flex flex-wrap gap-3 text-sm">
      <% if (!tenantBase) { %>
        <span class="text-gray-400">Kein Tenant-Kontext</span>
      <% } else if (!isTenantAdmin) { %>
        <span class="text-gray-400">Nur Admin</span>
      <% } else { %>
        <a href="<%= tenantBase %>/dashboard" class="<%= active === 'tenant' ? 'text-blue-700 font-medium' : 'text-gray-700' %> hover:underline">Dashboard</a>
        <a href="<%= tenantBase %>/users" class="<%= active === 'tenant' ? 'text-blue-700 font-medium' : 'text-gray-700' %> hover:underline">Users</a>
        <a href="<%= tenantBase %>/apps" class="<%= active === 'tenant' ? 'text-blue-700 font-medium' : 'text-gray-700' %> hover:underline">Tenant Apps</a>
        <a href="<%= tenantBase %>/groups" class="<%= active === 'tenant' ? 'text-blue-700 font-medium' : 'text-gray-700' %> hover:underline">Groups</a>
        <a href="<%= tenantBase %>/rbac" class="<%= active === 'tenant' ? 'text-blue-700 font-medium' : 'text-gray-700' %> hover:underline">RBAC</a>
        <a href="<%= tenantBase %>/forms/assignments" class="<%= active === 'tenant' ? 'text-blue-700 font-medium' : 'text-gray-700' %> hover:underline">Form Assignments</a>

        <!-- Integrations -> Webhooks -->
        <div class="w-full h-px bg-gray-100 my-2"></div>
        <span class="text-[11px] uppercase tracking-wide text-gray-400">Integrations</span>
        <a href="<%= tenantBase %>/integrations/webhooks" class="<%= active === 'tenant' ? 'text-blue-700 font-medium' : 'text-gray-700' %> hover:underline">Webhooks</a>
      <% } %>
    </div>
  </div>

  <!-- APPS -->
  <div class="bg-white rounded-xl shadow px-4 py-3">
    <div class="flex items-center justify-between mb-2">
      <div class="text-[11px] uppercase tracking-wide text-gray-400">Apps</div>
      <% if (active === "apps") { %>
        <span class="text-[10px] px-2 py-0.5 rounded-full bg-blue-50 text-blue-700 border border-blue-100">aktiv</span>
      <% } %>
    </div>

    <% if (!tenantBase) { %>
      <span class="text-gray-400 text-sm">Kein Tenant-Kontext</span>
    <% } else if (!apps || apps.length === 0) { %>
      <span class="text-gray-400 text-sm">Keine Apps aktiv</span>
    <% } else { %>
      <div class="flex items-center gap-3">
        <select
          class="text-sm rounded-lg border-gray-300 shadow-sm focus:ring-blue-500 focus:border-blue-500"
          onchange="if(this.value) window.location.href = this.value"
        >
          <option value="">App auswählen…</option>
          <% apps.forEach(a => {
               const name = a.name || a.app || a.key;
               const label = a.label || name;
               const url = tenantBase + "/app/" + encodeURIComponent(String(name));
          %>
            <option value="<%= url %>" <%= (activeApp && activeApp === String(name)) ? "selected" : "" %>>
              <%= label %>
            </option>
          <% }) %>
        </select>

        <% if (activeApp) { %>
          <span class="text-xs text-gray-500">
            Aktiv: <span class="font-mono"><%= activeApp %></span>
          </span>
        <% } %>
      </div>
    <% } %>
  </div>
</div>
